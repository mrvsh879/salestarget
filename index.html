<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Трекер плана продаж — MVP++</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f8fafc; font-family: system-ui, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    function App() {
      const DEFAULT_ITEMS = [
        { id: 'de', name: 'Немцы', code: 'DE', target: 15, actual: 0 },
        { id: 'ro', name: 'Румыны', code: 'RO', target: 10, actual: 0 },
        { id: 'pl', name: 'Поляки', code: 'PL', target: 12, actual: 0 }
      ];

      const LS_KEY = 'sales_mvp_progress_v1';

      const [items, setItems] = useState(DEFAULT_ITEMS);
      const [note, setNote] = useState('');

      const meta = useMemo(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayOfMonth = now.getDate();
        const monthProgress = dayOfMonth / daysInMonth;
        const remainingDays = daysInMonth - dayOfMonth;
        return { year, month, daysInMonth, dayOfMonth, monthProgress, remainingDays };
      }, []);

      useEffect(() => {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
          try { setItems(JSON.parse(saved)); } catch {}
        }
      }, []);

      useEffect(() => {
        localStorage.setItem(LS_KEY, JSON.stringify(items));
      }, [items]);

      const monthName = new Intl.DateTimeFormat('ru-RU', { month: 'long' }).format(new Date());

      function updateItem(id, patch) {
        setItems(prev => prev.map(it => it.id === id ? { ...it, ...patch } : it));
      }

      const totals = useMemo(() => {
        const target = items.reduce((s, i) => s + Number(i.target || 0), 0);
        const actual = items.reduce((s, i) => s + Number(i.actual || 0), 0);
        const expected = target * meta.monthProgress;
        const delta = actual - expected;
        const projected = actual / meta.dayOfMonth * meta.daysInMonth;
        return { target, actual, expected, delta, projected };
      }, [items, meta]);

      return (
        <div className="max-w-5xl mx-auto p-6">
          <h1 className="text-3xl font-bold mb-4">Трекер плана продаж — MVP</h1>
          <p className="text-slate-600 mb-6">Месяц: {monthName} {meta.year} — День {meta.dayOfMonth} из {meta.daysInMonth}</p>

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            <Summary title="План" value={totals.target.toFixed(1)} />
            <Summary title="Факт" value={totals.actual.toFixed(1)} />
            <Summary title="Прогноз" value={totals.projected.toFixed(1)} />
          </div>

          <table className="w-full text-sm border-separate border-spacing-y-2">
            <thead>
              <tr className="text-left text-slate-500">
                <th>Направление</th>
                <th>План</th>
                <th>Факт</th>
                <th>Отклонение</th>
              </tr>
            </thead>
            <tbody>
              {items.map(it => (
                <tr key={it.id} className="bg-white shadow-sm rounded-xl">
                  <td className="p-2 font-medium">{it.name}</td>
                  <td className="p-2"><input type="number" value={it.target} onChange={e=>updateItem(it.id,{target:Number(e.target.value)})} className="border rounded px-2 w-20" /></td>
                  <td className="p-2"><input type="number" value={it.actual} onChange={e=>updateItem(it.id,{actual:Number(e.target.value)})} className="border rounded px-2 w-20" /></td>
                  <td className="p-2 text-sm {it.actual>=it.target?'text-green-600':'text-red-600'}">{(it.actual - it.target).toFixed(1)}</td>
                </tr>
              ))}
            </tbody>
          </table>

          <div className="mt-6">
            <label className="text-sm text-slate-600">Заметка / комментарий</label>
            <textarea value={note} onChange={e=>setNote(e.target.value)} className="w-full border rounded-xl p-2 mt-1" />
          </div>
        </div>
      );
    }

    function Summary({title, value}) {
      return (
        <div className="bg-white border rounded-xl p-4 shadow-sm">
          <div className="text-xs text-slate-500">{title}</div>
          <div className="text-2xl font-bold">{value}</div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
